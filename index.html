<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>myingVue</title>
</head>

<body>
  <div id="app">
    <p>{{name}}</p>
    <input type="text" v-model="name">
    <div>{{name}}</div>
    <div>{{name1}}</div>
    <input type="text" v-model="name1">
  </div>
  <script>
    class Vue {
      constructor(options) {
        this.$options = options
        this.$data = options.data;
        this.$watcher = {}
        this.observe(this.$data)
        new Compile(options.el, this)
      }

      observe(obj) {
        const vm = this
        Object.keys(obj).forEach(key => {
          console.log();
          let value = obj[key]
          Object.defineProperty(obj, key, {
            get() {
              // console.log('获取数据');
              return value
            },
            set(newVal) {
              vm.update(key, newVal)
              // console.log('更新数据去触发dom更新');
              // 此处需要触发绑定过name的所有dom、所以在编译赋值的时候需要保存、由此引出——Watcher
              value = newVal
            }
          })
        })
      }

      addWatcher(key, node) {
        let nodes = this.$watcher[key] || []
        nodes.push(node)
        this.$watcher[key] = nodes
      }

      update(wkey, value) {
        this.$watcher[wkey].forEach(node => {
          node.textContent = value
        })
      }
    }

    // 编译
    class Compile {
      constructor(el, vm) {
        this.$el = document.querySelector(el)
        this.$vm = vm

        this.compile(this.$el)
      }

      compile(el) {
        const childNodes = Array.from(el.childNodes)

        childNodes.forEach((node) => {
          // 标签类型
          if (this.isElement(node)) {
            // 遍历attributes
            this.comAttributes(node)
            // console.log(node, node.nodeType, node.childNodes);
          }
          // 匹配出带有{{}}内容
          if (this.isText(node)) {
            // text类型
            this.compileText(node)
          }

          // 递归遍历所有节点
          if (node.childNodes && node.childNodes.length > 0) {
            this.compile(node)
          }
        });
      }

      // 编译行内指令
      comAttributes(node) {
        const {
          attributes
        } = node
        // console.log(attributes);
        Array.from(attributes).forEach((attr) => {
          const attrName = attr.name
          const attrValue = attr.value
          if (this.isDirective(attrName)) {
            const dir = attrName.substring(2)
            // 执行具体功能
            this[dir] && this[dir](node, attrValue)
            // console.log(attr, attrName, dir, attrValue);
          }
        })
      }

      // v-model赋值、监听input输入
      model(node, exp) {
        node.value = this.$vm.$data[exp]
        node.addEventListener('input', e => {
          this.$vm.$data[exp] = e.target.value
        })
      }

      // 编译文本
      compileText(node) {
        this.textUpdater(node, this.$vm.$data[RegExp.$1])
        // 记录Watcher
        this.$vm.addWatcher(RegExp.$1, node)
      }

      textUpdater(node, text) {
        node.textContent = text
      }

      isElement(node) {
        return node.nodeType === 1
      }

      isText(node) {
        return node.nodeType === 3 && /\{\{(.*)\}\}/.test(node.textContent)
      }

      // 自定义指令、包含v-且在最前面
      isDirective(attr) {
        return attr.indexOf('v-') === 0
      }
    }

    new Vue({
      el: '#app',
      data: {
        name: '123',
        name1: ''
      }
    })
  </script>
</body>

</html>